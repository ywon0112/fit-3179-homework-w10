{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {
    "text": "Average Rainfall by City",
    "subtitle": "Filter by state to compare city rainfall (2007-2017)"
  },
  "data": {
    "url": "data/rainfall_by_city.csv"
  },
  "width": 600,
  "height": 500,
  "background": "#f7f9fc",
  "params": [
    {
      "name": "stateSelection",
      "value": "All",
      "bind": {
        "input": "select",
        "name": "Filter by state: ",
        "element": "#state-filter-control",
        "options": [
          "All",
          "ACT",
          "NSW",
          "NT",
          "QLD",
          "SA",
          "TAS",
          "VIC",
          "WA"
        ]
      }
    }
  ],
  "transform": [
    {
      "filter": "stateSelection == 'All' || datum.State == stateSelection"
    },
    {
      "calculate": "datum.Location + ', ' + datum.State",
      "as": "CityState"
    },
    {
      "calculate": "toNumber(datum.average_annual_rainfall)",
      "as": "Rainfall"
    }
  ],
  "layer": [
    {
      "mark": {
        "type": "bar",
        "cornerRadiusEnd": 3
      },
      "encoding": {
        "y": {
          "field": "CityState",
          "type": "nominal",
          "sort": "-x",
          "axis": {
            "title": null,
            "labelLimit": 140
          }
        },
        "x": {
          "field": "Rainfall",
          "type": "quantitative",
          "title": "Average annual rainfall (mm)",
          "axis": {
            "tickCount": 6
          }
        },
        "color": {
          "field": "State",
          "type": "nominal",
          "title": "State",
          "scale": {
            "domain": ["ACT", "NSW", "NT", "QLD", "SA", "TAS", "VIC", "WA"],
            "range": [
              "#1f77b4",
              "#9467bd",
              "#8c564b",
              "#17becf",
              "#ff7f0e",
              "#7f7f7f",
              "#bc80bd",
              "#393b79"
            ]
          }
        },
        "tooltip": [
          {
            "field": "Location",
            "type": "nominal",
            "title": "City"
          },
          {
            "field": "State",
            "type": "nominal"
          },
          {
            "field": "Rainfall",
            "type": "quantitative",
            "title": "Rainfall",
            "format": ".1f"
          }
        ]
      }
    },
    {
      "transform": [
        {
          "aggregate": [
            {
              "op": "mean",
              "field": "Rainfall",
              "as": "meanRainfall"
            }
          ]
        }
      ],
      "mark": {
        "type": "rule",
        "color": "#5b5be0",
        "strokeDash": [6, 4],
        "strokeWidth": 2
      },
      "encoding": {
        "x": {
          "field": "meanRainfall",
          "type": "quantitative"
        }
      }
    },
    {
      "transform": [
        {
          "aggregate": [
            {
              "op": "mean",
              "field": "Rainfall",
              "as": "meanRainfall"
            }
          ]
        },
        {
          "calculate": "'National average: ' + format(datum.meanRainfall, '.0f') + ' mm'",
          "as": "annotation"
        }
      ],
      "mark": {
        "type": "text",
        "align": "left",
        "baseline": "bottom",
        "dx": 5,
        "dy": -6,
        "fontSize": 12,
        "fontWeight": "bold",
        "color": "#5b5be0"
      },
      "encoding": {
        "x": {
          "field": "meanRainfall",
          "type": "quantitative"
        },
        "y": {
          "value": -5
        },
        "text": {
          "field": "annotation",
          "type": "nominal"
        }
      }
    },
    {
      "transform": [
        {
          "window": [
            {
              "op": "rank",
              "as": "rainfall_rank"
            }
          ],
          "sort": [
            {
              "field": "Rainfall",
              "order": "descending"
            }
          ]
        },
        {
          "filter": "datum.rainfall_rank == 1"
        },
        {
          "calculate": "'Highest rainfall: ' + datum.Location",
          "as": "topAnnotation"
        },
        {
          "calculate": "datum.Rainfall - 80",
          "as": "topAnnotationX"
        }
      ],
      "mark": {
        "type": "text",
        "align": "right",
        "baseline": "middle",
        "dx": -6,
        "dy": -10,
        "fontSize": 11,
        "fontWeight": "bold",
        "color": "#2c3e7f"
      },
      "encoding": {
        "x": {
          "field": "topAnnotationX",
          "type": "quantitative"
        },
        "y": {
          "field": "CityState",
          "type": "nominal"
        },
        "text": {
          "field": "topAnnotation",
          "type": "nominal"
        }
      }
    }
  ],
  "config": {
    "legend": {
      "titleFontSize": 12,
      "labelFontSize": 11
    },
    "axis": {
      "labelFontSize": 11,
      "titleFontSize": 12
    },
    "view": {
      "stroke": null
    }
  }
}

